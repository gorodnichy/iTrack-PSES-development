---
# title: "iTrack: Public Service Employee Survey" # interactive results portal.
title: "Public Service Employee Survey Results: CBSA-SE" 
output: 
  flexdashboard::flex_dashboard:
    orientation: rows # rows #columns  #default rows
    social: menu
    vertical_layout: scroll # fill # scroll  #fill  #default fill
    navbar:
      - { title: "iTrack App", href: "https://itrack.shinyapps.io/PSES", align: right }
runtime: shiny
---


```{r global, include=FALSE, warning=FALSE, echo=F}
# load data in 'global' chunk so it can be shared by all users of the dashboard

source("readSED+QuestionMapping.R") # PSES-read-question-mapping.R")
#source("PSES-plotFunctions.R")
# source("PSES-ALL-readData.R")
# source("PSES-ALL-plot.R")

```
# Analyze interactively



## Row   {data-height=400}

<!-- {data-height=500}  -->

<!-- {.tabset .tabset-fade} -->



### Make Selection


```{r}

selectInput('organizationSED', 'Select Department(s) (click DEL to remove):', 
            # choices = c("All", dtSED$Organization %>% unique()), 
            # selected="All", #(dtSED$Organization %>% unique()), 
            choices = c(dtSED$Organization %>% unique()), 
            width="100%",
            selected=c(dtSED$Organization %>% unique())[c(1,2,5)], 
            multiple=T 
) 

# selectInput('themeSED', 'Select theme:',
#             choices = c("All", dtSED$Theme %>% unique()), width="100%",
#             selected="All")


if (T) {
  selectInput('questionSED', 'Select Question:', 
              width="100%", 
              selectize = F,size=10,
              choices = c(dtSED$strQuestion %>% unique())
  ) 
  #strQuestions, width="100%") 
}else {
  
  dtSED.subset<- reactive({
    if (input$theme=="All") {
      dtSED
    }else{
      dtSED[Theme == input$themeSED]
      #     dtSED %>% dplyr::filter(Theme==input$Zone)
    }
  })
  renderUI({
    selectInput('questionSED', 'Select Question:',
                choices = (dtSED.subset()$strQuestion ) %>% unique(),
                #selected= "Question 43. I would recommend my department or agency as a great place to work.",
                #selected =  ( (dtSED.subset()$strQuestion ) %>% unique() )[1],
                width="100%")
  })
}

dtSED0 <- reactive({
  dtSED[strQuestion %in% input$questionSED & 
          Organization %in% input$organizationSED, 
        c(1:11, ncol(dtSED)),with=F]
})


```



### Survey Results 

```{r psesSED.plotQuestionByTime_lines}
renderPlot({
  psesSED.plotQuestionByTime_lines(dtSED0(), input$questionSED);
})
```

## Row 2 {.tabset .tabset-fade}

###  Tabulated Results {data-height=600}

<!-- ### Outputs {data-width=600} -->


```{r}
DT::renderDataTable({
  data <- dtSED0()
  DT::datatable(data, options = list(
    bPaginate = FALSE
    #    pageLength = 10
  ))
})
# renderTable({
#   dtSED0()
# })
```



### Sources


- 2018 Public Service Employee Survey Results by Theme for Science and Engineering:    
[www.tbs-sct.gc.ca/pses-saff/2018/results-resultats/bq-pq/83/200/304/418/org-eng.aspx]({data-height=50} )
- 2017 Public Service Employee Survey Results for SCIENCE AND ENGINEERING:    
[www.tbs-sct.gc.ca/pses-saff/2017-2/results-resultats/bq-pq/83/002/022/026/org-eng.aspx]()
- 2014 Public Service Employee Survey Results by Question for Science and Engineering:   
[www.tbs-sct.gc.ca/pses-saff/2014/results-resultats/bq-pq/83/001/250/255/org-eng.aspx]()
- 2011 Public Service Employee Survey Organizational Results: Science and Engineering:   
[www.tbs-sct.gc.ca/pses-saff/2011/results-resultats/bq-pq/83/090/400/403/org-eng.aspx]()




<!-- Investigate: Track horizontally (Over time) 
# Detect:Track vertically (Over Org.Chart)  

-->




# Generate Report 


## Page 2 {data-orientation=rows}

### Generated by iTrack (https://itrack.shinyapps.io/PSES) {data-width=1000}

**Public Service Employee Survey Results**

Department: `SCIENCE AND ENGINEERING` 

<!-- Years: `2011,2014,2017,2018` -->

**Abstract: **


The following report is generated automatically from [Public Service Employee Survey (PSES)](https://www.canada.ca/en/treasury-board-secretariat/services/innovation/public-service-employee-survey.html) results data. 
It identifies the areas of leadership and concerns for  `SCIENCE AND ENGINEERING`, comparing its performance to that of other departments within the same orgzanization, and to its own performance in the past.
It presents the outcomes of the analysis of PSES results for `SCIENCE 

The performance of `SCIENCE AND ENGINEERING` over the years is measured using the so-called *"Happy" Score*, which is the weighted ratio of *Positive Responses* to *All Responses* to a PSES question: 

<!-- The Score is computed as assigning a score of 100 to the most positive response category, 75 to the second most positive response category, 50 for the middle response category, 25 to the second most negative response option, and 0 to the most negative response option.  -->

$$ Score  = { 100 \cdot Strongly\ agree  + 75 \cdot Somewhat\ agree + 50\cdot Neutral + 25 \cdot Somewhat \ disagree + 0\cdot Strongly\ disagree \over 
Strongly\ agree  + Somewhat\ agree  + Neutral + Somewhat\ disagree + Strongly\ disagree  } (\%) $$

#### Performance summary

```{r  warning=FALSE, echo=F}
source("PSES_functions.R")
source("PSES-plotFunctions.R")
readPsesData()

  myID <- myID0
    myID = getIDupto(myID0,3);

  setkeyv(dtDepartments,PSES_ID_COLS)  
  dtRESULT <<- dtPSES[SURVEYR %in% c(2018)][
    selectDepts (id=myID0), on=PSES_ID_COLS][
      dtQuestions, on="QUESTION"]

setkeyv(dtRESULT, PSES_ID_COLS)
#q <- (dtRESULT$QUESTION %>% unique)[2];q
for (q in dtRESULT$QUESTION %>% unique) {
  myScore <- dtRESULT[as.list(myID)][QUESTION==q]$SCORE100; myScore
  myRank <- dtPSES[QUESTION==q &  SCORE100 > myScore, .N] ; myRank
  dtRESULT[QUESTION==q, ':=' (
    RANK=dtPSES[QUESTION==q & LEVEL1ID > 0 &  SCORE100 > myScore, .N],
    TOTAL=dtPSES[QUESTION==q & LEVEL1ID > 0, .N]       )
    ] [, RANK2:=round(RANK/TOTAL*100)]
  dtRESULT[QUESTION==q & IDlevel == 0, ':=' (RANK2=50)]
}


Questions_vs_Scores(T) +
  labs(
    x="Score = Positive responses / All responses (%)",
    y=NULL,
    title=paste("2018 Public Service Employee Survey Results"), 
    subtitle=paste0("Department: ",
                    # "Department:", dtDepartments[as.list(myID)]$pathString, 
                    dtDepartments[as.list(myID0)]$Organization,
                    " (Ranking percentile is indicated in the box, Public Service average is marked by cross)"),
    caption = paste0("License: Open Government Licence - Canada\n Generated", #  on ", format(Sys.time(), "%d %B, %Y"), 
                     " by iTrack (https://itrack.shinyapps.io/PSES)")
  ) 
```




#### Areas of Leadership:

These are areas where the department ranked in Top 10% of Public Service:

  ```{r}

dtRESULT[as.list(myID0)][RANK2 <11, .(Theme, QUESTION, SCORE100, RANK2)]
```


#### Areas of Concern:


These are areas where the deparment ranked in Bottom 10% of Public Service:

```{r}
dtRESULT[as.list(myID0)][RANK2 >89, .(Theme, QUESTION, SCORE100, RANK2)]

concerns <- dtRESULT[as.list(myID0)][RANK2 >89]$QUESTION; 

```



#### Comparison to other departments within the same organization:

```{r}
myID <- myID0
    myID = getIDupto(myID0,3);

  setkeyv(dtDepartments,PSES_ID_COLS)  
  dtRESULT <<- dtPSES[SURVEYR %in% c(2018)][
    selectDepts (id=myID), on=PSES_ID_COLS][
      dtQuestions, on="QUESTION"]

setkeyv(dtRESULT, PSES_ID_COLS)
#q <- (dtRESULT$QUESTION %>% unique)[2];q
for (q in dtRESULT$QUESTION %>% unique) {
  myScore <- dtRESULT[as.list(myID)][QUESTION==q]$SCORE100; myScore
  myRank <- dtPSES[QUESTION==q &  SCORE100 > myScore, .N] ; myRank
  dtRESULT[QUESTION==q, ':=' (
    RANK=dtPSES[QUESTION==q & LEVEL1ID > 0 &  SCORE100 > myScore, .N],
    TOTAL=dtPSES[QUESTION==q & LEVEL1ID > 0, .N]       )
    ] [, RANK2:=round(RANK/TOTAL*100)]
  dtRESULT[QUESTION==q & IDlevel == 0, ':=' (RANK2=50)]
}


Questions_vs_Scores(T) +
  labs(
    x="Score = Positive responses / All responses (%)",
    y=NULL,
    title=paste("2018 Public Service Employee Survey Results"), 
    subtitle=paste0("Department: ",
                    # "Department:", dtDepartments[as.list(myID)]$pathString, 
                    dtDepartments[as.list(myID)]$Organization,
                    " (Ranking percentile is indicated in the box, Public Service average is marked by cross)"),
    caption = paste0("License: Open Government Licence - Canada\n Generated", #  on ", format(Sys.time(), "%d %B, %Y"), 
                     " by iTrack (https://itrack.shinyapps.io/PSES)")
  ) 



dtRESULT[QUESTION %in% concerns & IDlevel==4, .(Theme, QUESTION,   pathString, SCORE100)][order(QUESTION,SCORE100)]



```




#### Comparison to previous years:
  
  
```{r echo=FALSE, results='asis'}

for (t in unique(dtSED$Theme)) {
  cat(glue::glue("\n\n\n*Theme: {t}* \n\n\n "))
  
  for (q in unique(dtSED[Theme==t]$strQuestion)) {
    #cat(glue::glue("\n\n\n*{q}*\n\n\n")) 
    # cat(glue::glue("\n\n\n####  Q: \n\n\n")) 
    #    print(knitr::kable(dtSED[strQuestion==q, 1:11]))
    psesSED.plotQuestionByTime_lines(dtSED[strQuestion==q], q)
    
    "<br><br><p>"
  }
}



```
