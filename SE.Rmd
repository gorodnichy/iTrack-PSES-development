---
# title: "iTrack: Public Service Employee Survey" # interactive results portal.
title: "Public Service Employee Survey Results: CBSA-SE" 
output: 
  flexdashboard::flex_dashboard:
    orientation: rows # rows #columns  #default rows
    social: menu
    vertical_layout: scroll # fill # scroll  #fill  #default fill
    navbar:
      - { title: "iTrack", href: "https://itrack.shinyapps.io/PSES", align: right }
runtime: shiny
---

```{r PSES-iTrack-0-Globals.Rmd, child = 'PSES-0-Globals.Rmd'}
```

```{r app-specific-constants, include=FALSE, warning=FALSE, echo=F}

myID0 = c(83,200,304,418,0)
myID = myID0
myLevel=getLevel(myID)
myQ <- "Q43"
myQs <- c("Q43", "Q42")
myYears <- c(2018)

Rank.T <- 20

```



```{r SE-byYears.Rmd, child = 'SE-byYears.Rmd'}
```


# Generate Report 


## Page 2 {data-orientation=rows}

### Generated by [iTrack](https://itrack.shinyapps.io/PSES) on `r format(Sys.time(), "%d %B, %Y")`.  

**Public Service Employee Survey Results**

Department: `SCIENCE AND ENGINEERING` 

<!-- Years: `2011,2014,2017,2018` -->

**Abstract: **


The following report is generated automatically from [Public Service Employee Survey (PSES)](https://www.canada.ca/en/treasury-board-secretariat/services/innovation/public-service-employee-survey.html) results data. 
It identifies the areas of leadership and concerns for  `SCIENCE AND ENGINEERING`, comparing its performance to that of other departments within the same orgzanization, and to its own performance in the past.

The performance is measured using the so-called *"Happy" Score*, which is the weighted ratio of *Positive Responses* to *All Responses* to PSES questions: 

<!-- The Score is computed as assigning a score of 100 to the most positive response category, 75 to the second most positive response category, 50 for the middle response category, 25 to the second most negative response option, and 0 to the most negative response option.  -->

$$ Score  = { 100 \cdot Strongly\ agree  + 75 \cdot Somewhat\ agree + 50\cdot Neutral + 25 \cdot Somewhat \ disagree + 0\cdot Strongly\ disagree \over 
Strongly\ agree  + Somewhat\ agree  + Neutral + Somewhat\ disagree + Strongly\ disagree  } (\%) $$

#### Performance summary


```{r  warning=FALSE, echo=F, fig.height = 6, fig.width = 12, fig.align = "center"}


myID <- myID0
myID = getIDupto(myID0,3);

setkeyv(dtDepartments,PSES_ID_COLS)  
dtRESULT <<- dtPSES[SURVEYR %in% c(2018)][
  selectDepts (id=myID0), on=PSES_ID_COLS][
    dtQuestions, on="QUESTION"]

setkeyv(dtRESULT, PSES_ID_COLS)
#q <- (dtRESULT$QUESTION %>% unique)[2];q
for (q in dtRESULT$QUESTION %>% unique) {
  myScore <- dtRESULT[as.list(myID)][QUESTION==q]$SCORE100; myScore
  # myRank <- dtPSES[QUESTION==q &  SCORE100 > myScore, .N] ; myRank
  dtRESULT[QUESTION==q, ':=' (
    RANK=dtPSES[QUESTION==q & LEVEL1ID > 0 &  SCORE100 > myScore, .N],
    TOTAL=dtPSES[QUESTION==q & LEVEL1ID > 0, .N]       )
    ] [, RANK100:=round(RANK/TOTAL*100)]
  #  dtRESULT[QUESTION==q & IDlevel == 0, ':=' (RANK100=50)]
}


Questions_vs_Scores(F) +
  labs(
    x="Score = Positive responses / All responses (%)",
    y=NULL,
    title=paste("2018 Public Service Employee Survey Results"), 
    subtitle=paste0("Department: ",
                    # "Department:", dtDepartments[as.list(myID)]$pathString, 
                    dtDepartments[as.list(myID0)]$Organization,
                    " \n(Ranking percentile is indicated in the box, Public Service average is marked by cross)"),
    caption = paste0("License: Open Government Licence - Canada\n Generated", #  on ", format(Sys.time(), "%d %B, %Y"), 
                     " by iTrack (https://itrack.shinyapps.io/PSES)")
  ) 

```




#### Areas of Leadership:

Areas of Leadership are the areas where the department ranked in Top `r Rank.T`% of Public Service in its performance. For `SCIENCE AND ENGINEERING` these areas are the following:

```{r}


dtRESULT[as.list(myID0)][RANK100 <=Rank.T, .(Theme, QUESTION, SCORE100, RANK100)]
```


#### Areas of Concern:


Areas of Concern are the  areas where the deparment ranked in Bottom `r Rank.T`% of Public Service in its performance. For `SCIENCE AND ENGINEERING` these areas are the following:

```{r}
# dtRESULT[as.list(myID0)][RANK100 >= 100-Rank.T, .(Theme, QUESTION, SCORE100, RANK100)][order(-RANK100)]
dtRESULT[as.list(myID0)][RANK100 >= 100-Rank.T, .(
  Theme, QUESTION,
  #Question... = str_trunc(Question.Abbreviated, 44,ellipsis = ".."), 
  RANK100, SCORE100 )][order(-RANK100)]
# dtRESULT[as.list(myID0)][RANK100 >= 100-Rank.T, .(Theme, RANK100, SCORE100, Question.Abbreviated)][order(-RANK100)]

concerns <- dtRESULT[as.list(myID0)][RANK100 >= 100-Rank.T]$QUESTION; 

```



#### Comparison to other departments within the same organization:


```{r  warning=FALSE, echo=F, fig.height = 6, fig.width = 12, fig.align = "center"}

myID <- myID0
myID = getIDupto(myID0,3);

setkeyv(dtDepartments,PSES_ID_COLS)  
dtRESULT <<- dtPSES[SURVEYR %in% c(2018)][
  selectDepts (id=myID), on=PSES_ID_COLS][
    dtQuestions, on="QUESTION"]

setkeyv(dtRESULT, PSES_ID_COLS)
#q <- (dtRESULT$QUESTION %>% unique)[2];q
for (q in dtRESULT$QUESTION %>% unique) {
  myScore <- dtRESULT[as.list(myID)][QUESTION==q]$SCORE100; myScore
  myRank <- dtPSES[QUESTION==q &  SCORE100 > myScore, .N] ; myRank
  dtRESULT[QUESTION==q, ':=' (
    RANK=dtPSES[QUESTION==q & LEVEL1ID > 0 &  SCORE100 > myScore, .N],
    TOTAL=dtPSES[QUESTION==q & LEVEL1ID > 0, .N]       )
    ] [, RANK100:=round(RANK/TOTAL*100)]
  dtRESULT[QUESTION==q & IDlevel == 0, ':=' (RANK100=50)]
}

if (T) {
  Questions_vs_Scores(T) +
    labs(
      x="Score = Positive responses / All responses (%)",
      y=NULL,
      title=paste("2018 Public Service Employee Survey Results"), 
      subtitle=paste0("Department: ",
                      # "Department:", dtDepartments[as.list(myID)]$pathString, 
                      dtDepartments[as.list(myID)]$Organization,
                      "\n(Ranking percentile is indicated in the box, Public Service average is marked by cross)"),
      caption = paste0("License: Open Government Licence - Canada\n Generated", #  on ", format(Sys.time(), "%d %B, %Y"), 
                       " by iTrack (https://itrack.shinyapps.io/PSES)")
    ) 
}

if (F) {
  for (t in dtRESULT$Theme %>% unique ) {
    cat(paste0("\n\n", t, "\n"))
    
    for (q in dtRESULT$QUESTION%>% unique ) {
      cat(paste0(dtRESULT[QUESTION==q]$Question%>% unique , "\n\n SCORE100"))
      
      cat(
        sprintf("%s: %i  ", 
                dtRESULT[Theme == t & q %in% concerns & IDlevel==4]$pathString, 
                dtRESULT[Theme == t & q %in% concerns & IDlevel==4]$SCORE100
        )
      )
    }
  }
  
}



```




#### Comparison to previous years:


```{r echo=FALSE, results='asis'}

for (t in unique(dtSED$Theme)) {
  cat(glue::glue("\n\n\n*Theme: {t}* \n\n\n "))
  
  for (q in unique(dtSED[Theme==t]$strQuestion)) {
    #cat(glue::glue("\n\n\n*{q}*\n\n\n")) 
    # cat(glue::glue("\n\n\n####  Q: \n\n\n")) 
    #    print(knitr::kable(dtSED[strQuestion==q, 1:11]))
    psesSED.plotQuestionByTime_lines(dtSED[strQuestion==q], q)
    
    "<br><br><p>"
  }
}



```
