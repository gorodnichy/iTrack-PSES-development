

# By Department 
<!-- # By Question  {data-height=800}  -->


<!-- ## Row 1 {data-height=100}  -->



## Row 2 {.tabset .tabset-fade}



<!-- ### By Question  {data-height=800}  -->

### Score by Department {data-height=800} 


<!-- #### PLOT -->

```{r plot.Depts_vs_Scores}

# selectInput('question', "Select Question:" ,
#             width="100%",
#             choices = dtQuestions$Question %>% unique
# )

renderPlot({
  
  dtRESULT <<- dtPSES[SURVEYR == input$year][
    r.DeptSelected(), on=PSES_ID_COLS][
      #dtQuestions, on="QUESTION"] #WORKS
      #dtQuestions[Question == input$question], on="QUESTION"] # DOES NOT
      dtQuestions[QUESTION == r.nQ()], on="QUESTION"] # DOES NOT

  
  # This makes it crash @
  # if (dtRESULT[.N]$IDlevel == 0)
  #   dtRESULT <<-  dtRESULT[which.max(ANSCOUNT)]
  # else {
  #   dtRESULT <<-  dtRESULT [, ':='(SCORE100=median(SCORE100), ANSCOUNT=max(ANSCOUNT)) ,
  #                           by=.(SURVEYR,QUESTION,Organization)] %>%
  #     unique(by=c("SURVEYR","QUESTION","Organization"))
  # }
  # 
  
  
  Depts_vs_Scores(input) + 
    labs(
      title=dtQuestions[QUESTION == r.nQ()]$Question, 
      #title=paste0(input$year, " Public Service Employee Survey Results"),
      # subtitle=paste0(dtQuestions[Question == input$question]$Question,"\n(Number of responses is indicated in the box)"),
      subtitle=paste0(input$year, " Public Service Employee Survey Results (Number of responses is indicated in the box)")
      # 
      #paste("Department:", dtDepartments[as.list(myID)]$Organization, "(Number of responses is indicated in the box)"),
      
    )  
  
})

```


<!-- Compare by Question -->

<!-- Summary  -->
<!-- ============================================================ -->
<!-- # Overall performance -->
<!-- # Smmary -->


### Score by Org. Chart

<!-- `Error: Not able to load 'data.tree' package` -->


```{r echo=FALSE, results='asis'}

if (T){
  
  library(data.tree)
  #renderPlot({
  renderPrint({
    
    if (id1() == 0 ) {
      cat("Org. Chart for entire Public Service is too long.\n Please shorten it by selecting specific Agency or Department")
    } else {
      # dtRESULT <<- dtPSES[SURVEYR %in% input$year][
      #   r.DeptSelected(), on=PSES_ID_COLS][
      #     dtQuestions[Question==input$question], on="QUESTION"]
      
      
      # Problem here: --> moved it to start
      # if (dtRESULT[.N]$IDlevel == 0) {
      #   dtRESULT <<-  dtRESULT[which.max(ANSCOUNT)]
      # } else {
      #   dtRESULT <<-  dtRESULT [, ':='(SCORE100=median(SCORE100), ANSCOUNT=max(ANSCOUNT)) ,
      #                           by=.(SURVEYR,QUESTION,Organization)] %>%
      #     unique(by=c("SURVEYR","QUESTION","Organization"))
      # }
      # 
      
   dt <- dtRESULT[ , .(LEV_1, LEV_2,LEV_3,LEV_4, SCORE100, sep = "/")][, pathString:=paste(LEV_1, LEV_2,LEV_3,LEV_4, SCORE100, sep = "/")]   
  #dtRESULT[ , pathString:=paste(LEV_1, LEV_2,LEV_3,LEV_4, SCORE100, sep = "/")]
      dtRESULTtree <- as.Node(dt)
      
      print(dtRESULTtree) 
      #plot(dtRESULTtree)
    }
  })
  
}

```  



### Tabular view

#### Department:
```{r summary.deptnames}

renderText({
  dt <- dtDepartments[ as.list(c(id1(),id2(),id3(),id4(),id5() ) )]
  #   dt <- dtDepartments[ .(c(id1(),id2(),id3(),id4(),id5() ) )]
  sprintf("Level: %i. %s (%s, ID=%i.%i.%i.%.i.%i)" , 
          dt$IDlevel, dt$Organization, dt$AADD, 
          id1(),id2(),id3(),id4(),id5())
})
```

<!-- 
#### Questions:
```{r summary.q}

renderPrint({
dtQuestions[Theme==input$theme]$Question 
})

```
-->

#### Responses:
```{r summary.tabulated}


DT::renderDataTable({
  
  # dt <- getResultsParents (id=c(id1(),id2(),id3(),id4(),id5()),
  #                          nQ = dtQuestions[Theme %in% input$theme]$QUESTION,
  #                          aYears=input$year) 
  
  DT::datatable(
    #r.dtAll(),
    dtRESULT[, .(SURVEYR,QUESTION,IDlevel,pathString,SCORE100,ANSCOUNT)],
    options = list(
      bPaginate = T,
      pageLength = 10
    ))
})

```


