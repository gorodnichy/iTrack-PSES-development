---
#title: "iTrack: Public Service Employee Survey" 
title: "Public Service Employee Survey: Interactive Results Tracker" 
# author: "Interactive Results Tracker"
#date: "AADD (DDMMYY)" # 
# subtitle: "Interactive Report" # iTracker Interactive results tracker" DOES NOT SHOW !!
# author: "Generated by [iReport](https://o-canada.shinyapps.io/PSES)" 

output: 
  flexdashboard::flex_dashboard:
    orientation: rows #columns #  #__default columns__ rows columns
    social: menu
    #     social: [ "twitter", "facebook", "menu" ]
    vertical_layout: scroll # fill # scroll  #fill  #default fill
    # source_code: embed
    #navbar:
    #  - { title: "iReport", href: "https://o-canada.shinyapps.io/PSES-iReport/", align: right }
runtime: shiny
---


```{r GLOBAL_OpenData, include=FALSE, warning=FALSE, echo=F}
# load data in 'global' chunk so it can be shared by all users of the dashboard

source("PSES_functions.R")
source("PSES-plotFunctions.R")
source("readSED+QuestionMapping.R") # PSES-read-question-mapping.R")
readPsesData()


dtQuestions <- dtQuestions[order(QUESTION, decreasing = T)]
dtDepartments[IDlevel==0, pathString:="All Public Service"]
dtDepartments[IDlevel==1, pathString:=AADD]
# dtDepartments <- dtDepartments[order(Organization, decreasing = T)]

if (T) { #  Error in [.data.table: Type of RHS ('double') must match LHS ('integer'). 
  
  # dtPSES <- dtPSES[dtDepartments]
  # 
  # if (dtPSES[.N]$IDlevel == 0) {
  #   dtPSES <<-  dtPSES[which.max(ANSCOUNT)]
  # } else {
  #   dtPSES <<-  dtPSES [, ':='(SCORE100=median(SCORE100), ANSCOUNT=max(ANSCOUNT)) ,
  #                       by=.(SURVEYR,QUESTION,Organization)] 
  #   dtPSES <<- dtPSES %>% unique(by=c("SURVEYR","QUESTION","Organization"))
  # }
  
}

```



```{r PSES-iTrack-0-Selection.Rmd, child = 'PSES-iTrack-0-Selection.Rmd'}
```

<!--E. Latest results, Track over time-->
<!-- Compare -->
<!-- A.1. Analyze manually -->
<!-- Analyze  -->
<!-- B.1 Detect, Investigate, Recommend, Report  -->
<!-- * By Department, By Question, By Year -->
<!-- C.1 Track vertically (by department)-->
<!-- C.1 Track horizontally (by year)-->
<!-- D.1 Summary, Details, -->

<!-- # Visualize -->

<!-- # View by Question {data-orientation=columns} -->
<!-- ----------------------------------------------------------------------- -->


<!-- # Summary  -->
# By Question

## Row  {.tabset .tabset-fade}

### Score by Question {data-height=600} 

```{r plot.Questions_vs_Scores}

renderPlot({
  
  setkeyv(dtDepartments,PSES_ID_COLS)
  dtRESULT <<- dtPSES[SURVEYR %in% input$year][
    r.DeptSelected(), on=PSES_ID_COLS][
      dtQuestions, on="QUESTION"]
  
  setkeyv(dtRESULT, PSES_ID_COLS)
  #q <- (dtRESULT$QUESTION %>% unique)[2];q
  for (q in dtRESULT$QUESTION %>% unique) {
    myScore <- dtRESULT[as.list(myID)][QUESTION==q]$SCORE100; myScore
    myRank <- dtPSES[QUESTION==q &  SCORE100 > myScore, .N] ; myRank
    dtRESULT[QUESTION==q, ':=' (
      RANK=dtPSES[QUESTION==q & LEVEL1ID > 0 &  SCORE100 > myScore, .N],
      TOTAL=dtPSES[QUESTION==q & LEVEL1ID > 0, .N]       )
      ] [, RANK2:=round(RANK/TOTAL*100)]
    dtRESULT[QUESTION==q & IDlevel == 0, ':=' (RANK2=50)]
  }
  
  
  Questions_vs_Scores(input$sortby=="by score") +
    
    labs(
      x="Score = Positive responses / All responses (%)",
      y=NULL,
      title=paste(input$year, "Public Service Employee Survey Results"), 
      subtitle=paste0("Department: ",
                      # "Department:", dtDepartments[as.list(myID)]$pathString, 
                      dtDepartments[as.list(myID)]$Organization,
                      " (Ranking percentile is indicated in the box, Public Service average is marked by cross)"),
      caption = paste0("License: Open Government Licence - Canada\n Generated", #  on ", format(Sys.time(), "%d %B, %Y"), 
                       " by iTrack (https://itrack.shinyapps.io/PSES)")
    ) 
})
```

### Tabular view {data-height=600} 


#### Department:
```{r}

renderText({
  dt <- dtDepartments[ as.list(c(id1(),id2(),id3(),id4(),id5() ) )]
  #   dt <- dtDepartments[ .(c(id1(),id2(),id3(),id4(),id5() ) )]
  sprintf("Level: %i. %s (%s, ID=%i.%i.%i.%.i.%i)" , 
          dt$IDlevel, dt$Organization, dt$AADD, 
          id1(),id2(),id3(),id4(),id5())
})
```

#### Responses:
```{r}

DT::renderDataTable({
  
  # dt <- getResultsParents (id=c(id1(),id2(),id3(),id4(),id5()),
  #                          nQ = dtQuestions[Theme %in% input$theme]$QUESTION,
  #                          aYears=input$year) 
  
  DT::datatable(
    #r.dtAll(),
    dtRESULT[, .(SURVEYR,QUESTION,IDlevel, pathString,SCORE100,ANSCOUNT)],
    options = list(
      bPaginate = T,
      pageLength = 10
    ))
})

```




# By Department 
<!-- # By Question  {data-height=800}  -->


## Row 1 {data-height=50} 
```{r input.theme_question, echo=F}


if (F) {
  selectInput('theme', "Select Theme:",
              choices = c(dtQuestions$Theme %>% unique),
              # choices = c(dtQuestions[order(nTheme)]$Theme %>% unique),
              selected="Overall Environment"
  )
  
  
  renderUI({
    selectInput('question', "Select Question:" ,
                width="100%",
                selected=(dtQuestions[Theme %in% input$theme]$Question%>% unique() )[2],
                choices = (dtQuestions[Theme %in% input$theme]$Question %>% unique())       
    )
  })
  
} else {
  randN <- runif(1,1,
                 length(dtQuestions$Question %>% unique )) %>% round()
  
  randN <- rnorm(1,20,5) %>% round() %>% min(length(dtQuestions$Question %>% unique )) %>% max(1)
  
  selectInput('question', "Select Question:" ,
              width="100%",
              # selected=dtQuestions[QUESTION=="Q43"]$Question,
              selected=(dtQuestions$Question %>% unique ) [randN],
              choices = dtQuestions$Question %>% unique
  )
}




```




## Row 2 {.tabset .tabset-fade}



<!-- ### By Question  {data-height=800}  -->

### Score by Department {data-height=800} 


<!-- #### PLOT -->

```{r plot.Depts_vs_Scores}

# selectInput('question', "Select Question:" ,
#             width="100%",
#             choices = dtQuestions$Question %>% unique
# )

renderPlot({
  
  dtRESULT <<- dtPSES[SURVEYR == input$year][
    r.DeptSelected(), on=PSES_ID_COLS][
      #dtQuestions, on="QUESTION"] #WORKS
      dtQuestions[Question == input$question], on="QUESTION"] # DOES NOT
  
  
  # This makes it crash @
  # if (dtRESULT[.N]$IDlevel == 0)
  #   dtRESULT <<-  dtRESULT[which.max(ANSCOUNT)]
  # else {
  #   dtRESULT <<-  dtRESULT [, ':='(SCORE100=median(SCORE100), ANSCOUNT=max(ANSCOUNT)) ,
  #                           by=.(SURVEYR,QUESTION,Organization)] %>%
  #     unique(by=c("SURVEYR","QUESTION","Organization"))
  # }
  # 
  
  
  Depts_vs_Scores(input$sortby=="by score") + 
    labs(
      title=input$question, 
      #title=paste0(input$year, " Public Service Employee Survey Results"),
      # subtitle=paste0(dtQuestions[Question == input$question]$Question,"\n(Number of responses is indicated in the box)"),
      subtitle=paste0(input$year, " Public Service Employee Survey Results (Number of responses is indicated in the box)")
      # 
      #paste("Department:", dtDepartments[as.list(myID)]$Organization, "(Number of responses is indicated in the box)"),
      
    )  
  
})

```


<!-- Compare by Question -->

<!-- Summary  -->
<!-- ============================================================ -->
<!-- # Overall performance -->
<!-- # Smmary -->


### Score by Org. Chart

`Error: Not able to load 'data.tree' package`


```{r echo=FALSE, results='asis'}

if (F){
  
  library(data.tree)
  #renderPlot({
  renderPrint({
    
    if (id1() == 0 ) {
      cat("Org. Chart for entire Public Service is too long.\n Please shorten it by selecting specific Agency or Department")
    } else {
      dtRESULT <<- dtPSES[SURVEYR %in% input$year][
        r.DeptSelected(), on=PSES_ID_COLS][
          dtQuestions[Question==input$question], on="QUESTION"]
      
      
      # Problem here: --> moved it to start
      # if (dtRESULT[.N]$IDlevel == 0) {
      #   dtRESULT <<-  dtRESULT[which.max(ANSCOUNT)]
      # } else {
      #   dtRESULT <<-  dtRESULT [, ':='(SCORE100=median(SCORE100), ANSCOUNT=max(ANSCOUNT)) ,
      #                           by=.(SURVEYR,QUESTION,Organization)] %>%
      #     unique(by=c("SURVEYR","QUESTION","Organization"))
      # }
      # 
      dtRESULT[ , pathString:=paste(LEV_1, LEV_2,LEV_3,LEV_4, SCORE100, sep = "/")]
      
      dtRESULTtree <- as.Node(dtRESULT)
      
      print(dtRESULTtree) 
      #plot(dtRESULTtree)
    }
  })
  
}

```  



### Tabular view

#### Department:
```{r summary.deptnames}

renderText({
  dt <- dtDepartments[ as.list(c(id1(),id2(),id3(),id4(),id5() ) )]
  #   dt <- dtDepartments[ .(c(id1(),id2(),id3(),id4(),id5() ) )]
  sprintf("Level: %i. %s (%s, ID=%i.%i.%i.%.i.%i)" , 
          dt$IDlevel, dt$Organization, dt$AADD, 
          id1(),id2(),id3(),id4(),id5())
})
```

<!-- 
#### Questions:
```{r summary.q}

renderPrint({
dtQuestions[Theme==input$theme]$Question 
})

```
-->

#### Responses:
```{r summary.tabulated}


DT::renderDataTable({
  
  # dt <- getResultsParents (id=c(id1(),id2(),id3(),id4(),id5()),
  #                          nQ = dtQuestions[Theme %in% input$theme]$QUESTION,
  #                          aYears=input$year) 
  
  DT::datatable(
    #r.dtAll(),
    dtRESULT[Question==input$question, .(SURVEYR,QUESTION,IDlevel, pathString,SCORE100,ANSCOUNT)],
    options = list(
      bPaginate = T,
      pageLength = 10
    ))
})

```






# By Year

## Row 

<!-- Not enough data for selected Department. -->

Not available in Light version. -   
Please conntact developer to obtain Full version.


<!-- ```{r PSES-iTrack-byYear.Rmd, child = 'PSES-iTrack-byYear.Rmd'} -->
<!-- ``` -->



<!-- ```{r PSES-iTrack-report.Rmd, child = 'PSES-iTrack-AI.Rmd'} -->
<!-- ``` -->

```{r PSES-iTrack-report.Rmd, child = 'PSES-iTrack-report.Rmd'}
```



```{r PSES-iTrack-end.Rmd, child = 'PSES-iTrack-end.Rmd'}
```


```{r PSES-iTrack-report.Rmd, child = 'PSES-iTrack-FAQ.Rmd'}
```


```{r PSES-iTrack-ReleaseNotes.Rmd, child = 'PSES-iTrack-ReleaseNotes.Rmd'}
```


